name: "macos"
description: "Build macos"

runs:
  using: "composite"
  steps:
    # Check if the dependency cache exists
    # If it does, restore those paths; otherwise these paths are cached at the end of the workflow
    # NOTE: Cache can be cleared manually from the Github actions webpage
    - name: cache dependencies
      id: cache-deps
      uses: actions/cache@v3
      env:
        cache-name: cache-mcfost-dependencies
      with:
        path: |
          /usr/local/Cellar/gcc/13.1.0
          /usr/local/Cellar/hdf5/1.14.1
          /usr/local/Cellar/cfitsio/4.3.0
          /usr/local/Cellar/voro-dev/0.4.6+
          /usr/local/Cellar/sprng2/2.0
        key: ${{ runner.os }}-build-${{ env.cache-name }}

      # Restoring the brew installs from cache doesn't put files where mcfost expects
      # Manually create symlinks so the compiler can find everything
    - if: ${{ steps.cache-deps.outputs.cache-hit == 'true' }}
      name: add symbolic links if cache exists
      shell: bash
      run: |
        ln -s /usr/local/Cellar/gcc/13.1.0/bin/gfortran /usr/local/bin/gfortran
        ln -s /usr/local/Cellar/sprng2/2.0/include/* /usr/local/include
        ln -s /usr/local/Cellar/sprng2/2.0/lib/* /usr/local/lib
        ln -s /usr/local/Cellar/voro-dev/0.4.6+/include/* /usr/local/include
        ln -s /usr/local/Cellar/voro-dev/0.4.6+/lib/libvoro++* /usr/local/lib
        ln -s /usr/local/Cellar/hdf5/1.14.1/include/* /usr/local/include
        ln -s /usr/local/Cellar/hdf5/1.14.1/lib/lib* /usr/local/lib
        ln -s /usr/local/Cellar/cfitsio/4.3.0/lib/libcfitsio* /usr/local/lib

      # Only do these install steps if no cache is found
    - if: ${{ steps.cache-deps.outputs.cache-hit != 'true' }}
      name: install gfortran
      shell: bash
      run: brew reinstall gcc

    - if: ${{ steps.cache-deps.outputs.cache-hit != 'true' }}
      name: install hdf5
      shell: bash
      run: brew install hdf5

    - if: ${{ steps.cache-deps.outputs.cache-hit != 'true' }}
      name: install cfitsio
      shell: bash
      run: brew install cfitsio

    - if: ${{ steps.cache-deps.outputs.cache-hit != 'true' }}
      name: get custom taps needed for mcfost
      shell: bash
      run: brew tap danieljprice/all

    - if: ${{ steps.cache-deps.outputs.cache-hit != 'true' }}
      name: install voro++
      shell: bash
      run: brew install voro-dev

    - if: ${{ steps.cache-deps.outputs.cache-hit != 'true' }}
      name: install sprng2
      shell: bash
      run: brew install sprng2

    - name: compile mcfost
      env:
        MCFOST_INSTALL: "/usr/local"
        MCFOST_NO_XGBOOST: "yes"
        SYSTEM: "gfortran"
        MCFOST_GIT: "1"
      shell: bash
      run: |
        cd src
        make all INCLUDE=-I/usr/local/include LIBS=/usr/local/lib
