name: "linux"
description: "Build linux"

runs:
  using: "composite"
  steps:
    # Cache dependencies for mcfost to avoid downloading/installing them each time this workflow runs
    - name: cache dependencies
      id: cache-deps
      uses: john-shaffer/cache@main # Need this version to unpack the cache tar with sudo
      env:
        cache-name: cache-mcfost-dependencies
      with:
        path: |
          /home/runner/work/include
          /home/runner/work/lib
        key: ${{ runner.os }}-build-${{ env.cache-name }}

    - name: update gcc to v12 # Using gcc-11 will return a bug when compiling gas/wavelengths_gas.f90
      shell: bash
      run: |
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 12
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 12
        sudo update-alternatives --install /usr/bin/gfortran gfortran /usr/bin/gfortran-12 12
        sudo update-alternatives --config gcc

    # Only do this (lengthy) setup if dependency cache not found
    - if: ${{ steps.cache-deps.outputs.cache-hit != 'true' }}
      name: prepare mcfost environment
      shell: bash
      env:
        MCFOST_INSTALL: "/home/runner/work"
        MCFOST_NO_XGBOOST: "yes"
        SYSTEM: "gfortran"
        MCFOST_GIT: "1"
      run: |
        cd lib
        ./install.sh
        cd ..

    - name: compile mcfost
      shell: bash
      env:
        MCFOST_INSTALL: "/home/runner/work"
        MCFOST_NO_XGBOOST: "yes"
        SYSTEM: "gfortran"
        MCFOST_GIT: "1"
      run: |
        cd src
        make all
